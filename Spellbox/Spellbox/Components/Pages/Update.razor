@page "/update"
@using Spellbox.Model

@if (progressInt == 0)
{
    <MudButton @onclick="UpdateOracleDatabase" Variant="Variant.Filled" Color="Color.Success">Update</MudButton>
}
else
{
    @if (progressInt >= 1)
    {
        <MudText>Downloading bulk data...</MudText>
    }

    @if (progressInt >= 2)
    {
        <MudText>@cardList?.Count cards downloaded ~ !</MudText>
        <MudText>Parsing...</MudText>
    }

    @if (progressInt >= 3)
    {
        <MudText>Saving...</MudText>
    }

    @if (progressInt < 4)
    {
        <MudProgressCircular Color="Color.Default" Indeterminate="true" />
    }

    @if (progressInt == 4)
    {
        <MudText>@oracleList?.Count oracle cards parsed ~ !</MudText>
        <MudText>@variantList?.Count card variants parsed ~ !</MudText>
        <MudText>Done.</MudText>
    }
}

@inject HttpClient Http
@inject OracleDbContext oracleContext
@code {
    public int progressInt = 0;
    private string? bulkUri = "https://api.scryfall.com/bulk-data";
    private List<ScryfallCard>? cardList;
    private List<OracleCard>? oracleList;
    private List<CardVariant>? variantList;

    private async Task UpdateOracleDatabase()
    {
        // This speeds things up maybe???
        oracleContext.ChangeTracker.AutoDetectChangesEnabled = false;

        // Clear database tables
        oracleContext.OracleCards.RemoveRange(oracleContext.OracleCards.ToList());
        oracleContext.CardVariants.RemoveRange(oracleContext.CardVariants.ToList());

        progressInt ++;
        StateHasChanged();

        // Get ScryfallAPI bulk data
        var bulkData = await Http.GetFromJsonAsync<BulkData>(bulkUri);
        var oracleUri = bulkData?.Data?.Find(x => x.Type == "default_cards")?.Download_Uri;

        // Get ScryfallAPI default cards
        cardList = await Http.GetFromJsonAsync<List<ScryfallCard>>(oracleUri);

        if (cardList is not null)
        {
            progressInt ++;
            StateHasChanged();

            // Rejected card layouts
            var rejectedLayouts = new List<string> { 
                "art_series", 
                "double_faced_token",
                "token",
                "planar",
                "scheme",
                "vanguard",
                "emblem",
                "host"
                };

            var parsedOracleIds = new List<string>();
            var parsedVariantIds = new List<string>();

            foreach (ScryfallCard card in cardList)
            {
                // Do we care about the card?
                if (card.Games is null || !card.Games.Contains("paper")) {continue;}
                if (card.Layout is null || rejectedLayouts.Contains(card.Layout)) {continue;}
                if (card.Promo_Types != null && card.Promo_Types.Contains("thick")) {continue;}

                // Get oracle id
                string? _OracleId = "";
                if (card.Oracle_Id != null) {_OracleId = card.Oracle_Id;}
                else {_OracleId = card.Card_Faces?[0].Oracle_Id;}
                if (_OracleId is null) {continue;}

                // Fill CardVariant
                CardVariant parsedVariant = new CardVariant {
                    OracleId = _OracleId,
                    SetName = card.Set_Name,
                    SetCode = card.Set,
                    CollNum = card.Collector_Number,
                    Finishes = card.Finishes,
                    Artist = card.Artist,
                    Released = card.Released_At,
                    Rarity = card.Rarity,
                };
                if (card.Image_Uris != null)
                {
                    parsedVariant.Thumbs = new List<string> { card.Image_Uris.Small is null ? "" : card.Image_Uris.Small };
                    parsedVariant.Images = new List<string> { card.Image_Uris.Normal is null ? "" : card.Image_Uris.Normal };
                    parsedVariant.FlavorTexts = new List<string> { card.Flavor_Text is null ? "" : card.Flavor_Text };
                    parsedVariant.FlavorNames = new List<string> { card.Flavor_Name is null ? "" : card.Flavor_Name };
                }
                else if (card.Card_Faces != null)
                {
                    parsedVariant.Thumbs = (from face in card.Card_Faces select face.Image_Uris?.Small is null ? "" : face.Image_Uris.Small).Cast<string>().ToList();
                    parsedVariant.Images = (from face in card.Card_Faces select face.Image_Uris?.Normal is null ? "" : face.Image_Uris.Normal).Cast<string>().ToList();
                    parsedVariant.FlavorTexts = (from face in card.Card_Faces select face.Flavor_Text is null ? "" : face.Flavor_Text).Cast<string>().ToList();
                    parsedVariant.FlavorNames = (from face in card.Card_Faces select face.Flavor_Name is null ? "" : face.Flavor_Name).Cast<string>().ToList();
                }
            
                // Check if the card is already in the Oracle database
                if (parsedOracleIds.Contains(_OracleId))
                {
                    // Check if the variant is already in the Oracle database
                    if (parsedVariantIds.Contains(_OracleId + card.Set + card.Collector_Number)) {continue;}

                    // Update existing oracle card with a new variant
                    parsedVariantIds.Add(_OracleId + card.Set + card.Collector_Number);
                    oracleContext.CardVariants.Add(parsedVariant);
                }
                else
                {
                    // Fill CardFaces
                    List<CardFace> parsedFaces = new List<CardFace>();
                    if (card.Card_Faces is null)
                    {
                        CardFace newFace = new CardFace {
                            Name = card.Name,
                            ManaCost = card.Mana_Cost,
                            TypeLine = card.Type_Line,
                            OracleText = card.Oracle_Text,
                            Power = card.Power,
                            Toughness = card.Toughness,
                            Defense = card.Defense
                        };
                        parsedFaces.Add(newFace);
                    }
                    else
                    {
                        foreach (ScryfallCardFace face in card.Card_Faces)
                        {
                            CardFace newFace = new CardFace {
                                Name = face.Name,
                                ManaCost = face.Mana_Cost,
                                TypeLine = face.Type_Line,
                                OracleText = face.Oracle_Text,
                                Power = face.Power,
                                Toughness = face.Toughness,
                                Defense = card.Defense
                            };
                            parsedFaces.Add(newFace);
                        }
                    }
                    
                    // Fill OracleCard and add to database
                    OracleCard parsedCard = new OracleCard {
                        OracleId = _OracleId,
                        Name = card.Name,
                        Faces = parsedFaces,
                        ColorIdentity = card.Color_Identity,
                        CMC = card.CMC,
                        Variants = new List<CardVariant> { parsedVariant },
                        Keywords = card.Keywords,
                        TypeLine = card.Type_Line is null ? card.Card_Faces?[0].Type_Line : card.Type_Line,
                        Legalities = card.Legalities
                    };

                    parsedOracleIds.Add(_OracleId);
                    oracleContext.OracleCards.Add(parsedCard);
                }
            }
        }
        progressInt ++;
        StateHasChanged();

        await oracleContext.SaveChangesAsync();

        oracleList = await oracleContext.OracleCards.ToListAsync();
        variantList = await oracleContext.CardVariants.ToListAsync();

        progressInt ++;
        StateHasChanged();
    }

    private class BulkData
    {
        public List<ScryfallBulk>? Data { get; set; }
    }
}