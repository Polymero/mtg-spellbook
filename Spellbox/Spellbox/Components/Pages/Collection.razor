@page "/collection"
@using MudBlazor
@using Spellbox.Model
@using Spellbox.Components.Dialogs

<MudGrid Spacing="2">

    <MudItem xs="12">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h4">
                    Your Binders:
                </MudText>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudButton @onclick="OpenAddBinderDialog" 
                           Variant="Variant.Filled" 
                           Color="Color.Success">
                    Add
                </MudButton>
            </CardHeaderActions>
        </MudCardHeader>
    </MudItem>

    @if (BinderCache == null)
    {
        <MudProgressCircular Color="Color.Default" Indeterminate="true" />
    }
    else if (BinderCache.Count == 0)
    {
        <MudText>
            You have no binders. What have you done?
        </MudText>
    }
    else
    {    
        @foreach (var binder in BinderCache)
        {
            <MudItem xs="12">
                <MudCard Outlined="true">
                    <MudCardContent>
                        <MudText Typo="Typo.h6">
                            @binder.Name (@binder.Cards.Count cards)
                        </MudText>
                        <MudText>
                            @binder.Description
                        </MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        }   
    }

</MudGrid>

@inject IDbContextFactory<CollectionDbContext> DbFactory
@inject IDialogService DialogService
@code {
    private List<CollectionBinder> BinderCache { get; set; } = new List<CollectionBinder>();

    protected override async Task OnInitializedAsync()
    {
        await LoadBindersAsync();
    }

    // Load binders into cache for UI
    private async Task LoadBindersAsync()
    {
        using var context = await DbFactory.CreateDbContextAsync();
        BinderCache = await context.Binders
                                   .OrderBy(b => b.Name)
                                   .ToListAsync();
    }

    // Open dialog to add a binder to the collection database
    private async Task OpenAddBinderDialog()
    {
        var options = new DialogOptions { CloseButton = true, CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<AddBinderDialog>("Add Binder", options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is CollectionBinder newBinder)
        {
            BinderCache.Add(newBinder);
            StateHasChanged();
        }
    }
}
